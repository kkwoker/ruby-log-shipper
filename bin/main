#!/usr/bin/env ruby

require 'bundler/setup'
require 'aws-sdk'
require 'elasticsearch'
require 'pry'
require 'terminal-announce'
require_relative '../lib/log_shipper'

# Read from SQS
LogShipper.sqs_poller.poll do |messages|
  requests = messages.map do |msg|
    body = JSON.parse(msg.body)
    {
      index: {
        _index: body['project'],
        _type: body['type'],
        body: { message: body['message'], '@timestamp': body['@timestamp'] },
        timestamp: body['@timestamp']
      }
    }
  end

  # Write to Elasticsearch in a Batch
  LogShipper.es_client.bulk(body: requests)
end

