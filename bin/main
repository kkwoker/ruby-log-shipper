#!/usr/bin/env ruby

require 'bundler/setup'
require 'aws-sdk'
require 'elasticsearch'
require 'pry'
require 'terminal-announce'
require_relative '../config'

def ship
  LogShipper.sqs_poller.poll do |messages|
    requests = convert_to_es_request(messages)
    LogShipper.es_client.bulk(body: requests)
  end
end

def convert_to_es_request(messages)
  messages.map do |msg|
    body = JSON.parse(msg.body)
    {
      index: {
        _index: body['project'],
        _type: body['type'],
        body: { message: body['message'], '@timestamp' => body['@timestamp'] },
        timestamp: body['@timestamp']
      }
    }
  end
end

threads = []
LogShipper.threads.times do
  threads << Thread.new { ship }
end

threads.each(&:join)
